name: Merge Translations

on:
  pull_request:
    types: [opened, synchronize]  # Виконання при створенні та оновленні PR
    paths:
      - 'uk/**/ukrainian.po'  # Шлях до файлів українських перекладів
      - 'uk/**/strings.pot'   # Шлях до оригінальних файлів

jobs:
  merge_translations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.12" ]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          ref: '${{ github.head_ref }}'
          python-version: ${{ matrix.python-version }}

      - name: Display Python version
        run: python -c "import sys; print(sys.version)"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install polib
          if  [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Checkout Source Branch (l10n_test)
        uses: actions/checkout@v4
        with:
          ref: '${{ github.head_ref }}'
      - name: Merge Missing Translations
        run: |
          cat <<EOF > merge_translations.py
          import polib
          import re
      
          pot_file = polib.pofile("uk/strings.pot", wrapwidth = 0)
          po_file = polib.pofile("uk/ukrainian.po", wrapwidth = 0)
      
          for entry in po_file:
              if entry.msgid:
                  matching_entry = next((e for e in pot_file if e.msgid == entry.msgid), None)
                  if matching_entry:
                      entry.comment = matching_entry.msgctxt
                      entry.msgctxt = matching_entry.msgctxt
              entry.msgid = entry.msgid.replace('\\\\\\\\', '\\\\')
              entry.msgstr = entry.msgstr.replace('\\\\\\\\', '\\\\')
      
          po_file.save("uk/ukrainian.po")
          EOF
          python merge_translations.py
      - name: Commit Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add uk/ukrainian.po
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git commit -m "Add missing translations with context from strings.pot" || echo "No changes to commit"
          git pull origin ${{ github.head_ref }} --rebase
          git push origin HEAD:${{ github.head_ref }}
